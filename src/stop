#!/usr/bin/env bash
CYAN="\033[1;36m"
GREEN="\033[1;32m"
MAGENTA="\033[1;35m"
YELLOW="\033[1;33m"
RED="\033[1;31m"
RESET="\033[0m"
BOLD="\033[1m"

TUNNEL_NAME="tunnel"
TUNNEL_CONF="tunnel.conf"

trap_ctrlc() {
    echo -e "\n${YELLOW}[⚠] Operation cancelled by user.${RESET}"
    exit 1
}
trap trap_ctrlc INT

print_banner() {
    clear
    local cols=$(tput cols)
    local line="DRAGON_TUNNEL"
    local border=$(printf '%*s' "$cols" '' | tr ' ' '_')
    echo -e "${MAGENTA}${border}${RESET}"
    local padding=$(( (cols - ${#line}) / 2 ))
    echo -e "${CYAN}${BOLD}$(printf '%*s' $padding '')${line}${RESET}"
    echo -e "${MAGENTA}${border}${RESET}"
    echo
}

print_banner

if [ ! -f "$TUNNEL_CONF" ]; then
    echo -e "${YELLOW}[⚠] No tunnel.conf found! Attempting to recreate it...${RESET}"
    sudo wg > "$TUNNEL_CONF" 2>/dev/null

    if [ -s "$TUNNEL_CONF" ]; then
        echo -e "${GREEN}[✔] tunnel.conf successfully recreated.${RESET}"
    else
        echo -e "${RED}[✖] Failed to recreate tunnel.conf. Make sure WireGuard is installed and configured.${RESET}"
        exit 1
    fi
fi

if ip link show "$TUNNEL_NAME" &> /dev/null; then
    CURRENT_LINK=$(strings "$TUNNEL_CONF" | grep -oP 'https://\w+\.tunnel\.pyjam\.as')
    if [ -n "$CURRENT_LINK" ]; then
        echo -e "${YELLOW}[⚠] Current tunnel link: ${CYAN}${CURRENT_LINK}${RESET}"
    fi

    echo -e "${YELLOW}[!] Stopping the active tunnel...${RESET}"
    sudo wg-quick down ./"$TUNNEL_CONF" &> /dev/null
    STATUS=$?

    if [ $STATUS -eq 0 ]; then
        echo -e "${GREEN}[✔] Tunnel stopped successfully!${RESET}"
    else
        echo -e "${RED}[✖] Failed to stop the tunnel. Make sure it is active or configured properly.${RESET}"
    fi
else
    echo -e "${GREEN}[✔] No active tunnel detected. Nothing to stop.${RESET}"
fi

echo
